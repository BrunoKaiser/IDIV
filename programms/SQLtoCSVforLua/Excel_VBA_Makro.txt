'This macro builds SQL in Excel, execute them and write data in Excel sheets and write documentation as tree in html files

Sub Load_Data_Test()
Open ThisWorkbook.Path & "\" & Replace(ThisWorkbook.Name, ".", "_") & "_SQL_Dokumentation_Filter_3.html" For Output As #1
Print #1, "<h1>SQL-Dokumentation</h1>"
Print #1, "<h2>" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & "</h1>"
Print #1, "<h3>Sub Load_Data</h3>"
Close #1

strConnection = "Data Source=" & ThisWorkbook.Worksheets("Steuerung").Cells(2, 2) & ";Extended Properties=""Excel 12.0 Xml; HDR=YES"""
'
sqlText = "SELECT [" & ThisWorkbook.Worksheets("Steuerung").Cells(2, 3) & "$].[test] AS test,[" & ThisWorkbook.Worksheets("Steuerung").Cells(2, 3) & "$].a " _
            & " FROM [" & ThisWorkbook.Worksheets("Steuerung").Cells(2, 3) & "$] " _
            & " LEFT JOIN (SELECT * FROM [Excel 12.0 Xml;HDR=Yes;Database=" & ThisWorkbook.Worksheets("Steuerung").Cells(3, 2) & "].[" & ThisWorkbook.Worksheets("Steuerung").Cells(3, 3) & "$]) [a$] " _
            & " ON [" & ThisWorkbook.Worksheets("Steuerung").Cells(2, 3) & "$].[test] = [a$].test ; "
Load_Data_with_filter "Konten_ges", sqlText, strConnection
'
End Sub 'Sub Load_Data()

Function Load_Data_with_filter(TableString As String, sqlText As Variant, strConnection As Variant)
'delete data before processing
Set src0 = ThisWorkbook
src0.Worksheets(TableString).UsedRange.Clear '"a"
'Connecting to the data source
Set cn = CreateObject("ADODB.Connection")
cn.Provider = "Microsoft.ACE.OLEDB.12.0"
'
cn.ConnectionString = strConnection '"Data Source=C:\Temp\test.xlsx;Extended Properties=""Excel 12.0 Xml; HDR=YES"""
cn.Open
'test with:
Debug.Print (sqlText)
Open ThisWorkbook.Path & "\" & Replace(ThisWorkbook.Name, ".", "_") & "_SQL_Dokumentation_" & outputDokuFile & ".html" For Append As #1
Print #1, "<details><summary style=""margin-left: 2em"">Tabelle: " & TableString & "</summary>"
Print #1, "<p style=""margin-left: 4em"">"
Print #1, sqlText
Print #1, "</p>"
Print #1, "</details><!-- Tabelle: " & TableString & "-->"
Close #1
Set rs = cn.Execute(sqlText)
'count fields of SQL
iColumnNumber = 0
rowNumber = 0
For Each fld In rs.Fields
    'test with: Debug.Print fld.Name
    iColumnNumber = iColumnNumber + 1
Next fld
'print headers
For counter = 0 To iColumnNumber - 1
    src0.Worksheets(TableString).Cells(1, counter + 1).Value = rs(counter).Name  '"a"
    'test with: Debug.Print rs(counter).Name
    If rs(counter).Name = "test" Or rs(counter).Name = "test2" Then  'test und test2 formatieren
               'test with: Debug.Print "Format"
               src0.Worksheets(TableString).Columns(counter + 1).NumberFormat = "[>=0][Black]#,##0.00;[<0][Red]-#,##0.00"
    ElseIf rs(counter).Name = "date1" Or rs(counter).Name = "date2" Then
               src0.Worksheets(TableString).Columns(counter + 1).NumberFormat = "dd.mm.yyyy"
    End If 'If rs(counter).Name = "test" Or rs(counter).Name = "test2" Then  'test und test2 formatieren
Next 'For counter = 0 To iColumnNumber - 1
'produce results
src0.Worksheets(TableString).Range("A2").CopyFromRecordset rs
'slow loop as alternative
'Do While Not rs.EOF
'    rowNumber = rowNumber + 1
'    For counter = 0 To iColumnNumber - 1
'        src0.Worksheets(TableString).Cells(rowNumber + 1, counter + 1).Value = rs(counter)  '"a"
'        'test with: Debug.Print rs(counter)
'    Next 'For counter = 0 To iColumnNumber - 1
'    rs.Movenext
'Loop 'Do While Not rs.EOF
rs.Close
cn.Close
Set cn = Nothing
Set rs = Nothing
End Function 'function Load_Data_with_filter()


